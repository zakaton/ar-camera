<html>
  <head>
    <title>Quest Pro | AR Camera</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://rawgit.com/blairmacintyre/aframe-look-at-billboard-component/master/dist/aframe-look-at-billboard-component.min.js"></script>
  </head>

  <style>
    html,
    body {
      margin: 0;
      padding: 0;
    }
    #overlay {
      position: absolute;
      z-index: 1;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }
    #overlay .clickable {
      pointer-events: all;
    }
    #overlay .hidden {
      display: none;
    }
  </style>

  <body>
    <a-scene>
      <a-assets></a-assets>

      <a-camera id="camera"> </a-camera>
    </a-scene>
  </body>

  <script>
    const scene = document.querySelector("a-scene");
    const assets = scene.querySelector("a-assets");

    let imageList;
    async function listImages() {
      const response = await fetch("/api/image/list");
      imageList = await response.json();
      console.log(imageList);
    }
    async function getImages() {
      if (!imageList) {
        await listImages();
      }
      imageList.forEach(async (imageName) => {
        await getImage(imageName);
      });
    }
    async function getImage(imageName) {
      const response = await fetch(`/api/image/get?name=${imageName}`);
      const blob = await response.blob();
      const image = new Image();
      console.log(blob);
      image.src = URL.createObjectURL(blob);
      console.log(image);
      // FILL - add to assets and whatnot...
      // FILL - replace existing image if already in assets
      document.body.appendChild(image);
    }

    // WEBSOCKETS
    let ws;
    function initWebsocket() {
      ws = new WebSocket(`wss://${location.host}`);
      console.log(ws);
      ws.addEventListener("open", () => {
        console.log("opened websocket connection");
      });
      ws.addEventListener("close", () => {
        console.log("websocket connection closed");
        setTimeout(() => {
          initWebsocket();
        }, 1000);
      });
      ws.addEventListener("message", async (event) => {
        const blob = event.data;
        const arrayBuffer = await blob.arrayBuffer();
        const message = JSON.parse(textDecoder.decode(arrayBuffer));
        //console.log("websocket message", message);
        onMessage(message);
      });
    }
    function isWebsocketConnected() {
      return ws.readyState == WebSocket.OPEN;
    }
    function sendMessage(message) {
      if (isWebsocketConnected()) {
        ws.send(JSON.stringify(message));
      }
    }
    const MessageTypeStrings = [
      // FILL - message types
    ];
    const MessageTypes = {};
    MessageTypeStrings.forEach(
      (string, index) => (MessageTypes[string] = index)
    );
    function onMessage(message) {
      console.log(message);
    }

    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d");

    const textDecoder = new TextDecoder();
    const textEncoder = new TextEncoder();

    initWebsocket();
  </script>
</html>
